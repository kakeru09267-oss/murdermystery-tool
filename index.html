<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>捜査ツール</title>
    <style>
        :root { --main-bg: #1a1a1a; --text-color: #e0e0e0; --accent: #c0392b; --card-bg: #2c3e50; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: var(--main-bg); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; border: 1px solid #444; padding: 20px; border-radius: 8px; background: #222; }
        h1 { text-align: center; color: var(--accent); font-size: 1.5rem; }
        .status-bar { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .limit-timer { font-size: 0.9rem; color: #f1c40f; text-align: center; margin-bottom: 10px; font-weight: bold; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--card-bg); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: 0.3s; text-align: center; text-decoration: none; }
        .btn:hover { background: #3e5871; }
        .evidence-card { background: #333; padding: 15px; border-left: 5px solid var(--accent); margin-bottom: 10px; white-space: pre-wrap; }
        .hidden { display: none; }
        #copy-area { width: 100%; height: 180px; background: #000; color: #0f0; padding: 10px; box-sizing: border-box; font-family: monospace; border: 1px solid #444; }
        .footer-note { font-size: 0.8rem; color: #888; text-align: center; margin-top: 20px; }

        /* カスタムモーダルのスタイル */
        #custom-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: #2c3e50; border: 2px solid var(--accent); padding: 30px;
            border-radius: 10px; text-align: center; max-width: 80%;
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.5);
        }
        .modal-text { font-weight: bold; margin-bottom: 20px; color: #fff; }
        .modal-btn {
            background: var(--accent); color: white; border: none; padding: 10px 30px;
            border-radius: 5px; cursor: pointer; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 id="chapter-title">◎章捜査</h1>
    <div id="timer-display" class="limit-timer"></div>
    <div id="status" class="status-bar">捜査回数: <span id="count">0</span> / 10</div>

    <div id="view-main">
        <button class="btn" onclick="startInvestigation()">捜査を開始する</button>
    </div>

    <div id="view-list" class="hidden">
        <h3>捜査箇所を選択してください</h3>
        <div id="location-buttons"></div>
    </div>

    <div id="view-result" class="hidden">
        <h3 id="result-title"></h3>
        <div id="result-content" class="evidence-card"></div>
        <div id="more-investigate" class="hidden" style="color: #f1c40f; margin-bottom: 15px;">
            ⚠️ 捜査回数を消費し、さらに調べることができそうだ。
        </div>
        <button id="back-btn" class="btn" onclick="showList()">戻る</button>
    </div>

    <div id="view-end" class="hidden">
        <h2 style="color:var(--accent)">捜査終了</h2>
        <p id="end-reason">捜査が終了しました。</p>
        <p style="font-size:0.9rem;">得られた情報をコピーして整理してください：</p>
        <textarea id="copy-area" readonly></textarea>
        <p style="font-size:0.8rem; color:#888;">※情報の再確認はこの画面でのみ可能です。</p>
    </div>

    <div class="footer-note">誤タップや誤操作にはご注意ください</div>
</div>

<div id="custom-modal" class="hidden">
    <div class="modal-content">
        <div id="modal-msg" class="modal-text"></div>
        <button class="modal-btn" onclick="closeModal()">了解</button>
    </div>
</div>

<script>
/**
 * 設定項目（ここを章ごとに書き換えてください）
 */
const CHAPTER_NAME = "1章捜査"; 
const SAVE_KEY = "investigation_save_ch1"; 
const LIMIT_DATE = "2026-01-20T21:00:00"; 
const MAX_SEARCH = 10;                     

const MASTER_DATA = {
    "教室": ["証拠A", "証拠B"],
    "個室": [],
    "保健室": ["証拠C"],
    "校舎-廊下": [],
    "校舎-階段": ["証拠D"]
};

let gameState = { count: 0, foundEvidences: [], investigatedIndices: {} };

function showCustomModal(msg) {
    document.getElementById('modal-msg').innerText = msg;
    document.getElementById('custom-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('custom-modal').classList.add('hidden');
}

function init() {
    // CHAPTER_NAMEをタイトルに反映
    document.getElementById('chapter-title').innerText = CHAPTER_NAME;
    // 分母の回数も反映
    document.getElementById('status').innerHTML = `捜査回数: <span id="count">0</span> / ${MAX_SEARCH}`;

    checkTimeLimit();
    setInterval(checkTimeLimit, 1000);

    // SAVE_KEYを使って読み込み
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) {
        gameState = JSON.parse(saved);
        updateStatus();
        if (gameState.count >= MAX_SEARCH) { showEnd("捜査可能回数の上限に達しました"); return; }
    }
    renderLocationButtons();
}

function checkTimeLimit() {
    const now = new Date();
    const limit = new Date(LIMIT_DATE);
    const diff = limit - now;

    if (diff <= 0) {
        showEnd("捜査終了時刻を過ぎました");
    } else {
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const mins = Math.floor((diff / (1000 * 60)) % 60);
        const secs = Math.floor((diff / 1000) % 60);
        let timeStr = "終了まで残り: ";
        if (days > 0) timeStr += `${days}日 `;
        timeStr += `${hours}時間 ${mins}分 ${secs}秒`;
        document.getElementById('timer-display').innerText = timeStr;
    }
}

function save() {
    // SAVE_KEYを使って保存
    localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
}

function updateStatus() {
    document.getElementById('count').innerText = gameState.count;
}

function renderLocationButtons() {
    const container = document.getElementById('location-buttons');
    container.innerHTML = '';
    Object.keys(MASTER_DATA).forEach(loc => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerText = loc;
        btn.onclick = () => investigate(loc);
        container.appendChild(btn);
    });
}

function startInvestigation() {
    if (new Date() > new Date(LIMIT_DATE)) { showEnd("捜査終了時刻を過ぎています"); }
    else if (gameState.count >= MAX_SEARCH) { showEnd("捜査可能回数の上限に達しています"); }
    else { showList(); }
}

function showList() {
    if (gameState.count >= MAX_SEARCH) { showEnd("捜査可能回数の上限に達しました"); return; }
    hideAll();
    document.getElementById('view-list').classList.remove('hidden');
}

function hideAll() {
    ['view-main', 'view-list', 'view-result', 'view-end'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
}

function investigate(location) {
    gameState.count++;
    updateStatus();
    
    const infoList = MASTER_DATA[location];
    const currentIndex = gameState.investigatedIndices[location] || 0;
    
    hideAll();
    const resultView = document.getElementById('view-result');
    const resultContent = document.getElementById('result-content');
    const moreNote = document.getElementById('more-investigate');
    const backBtn = document.getElementById('back-btn');
    
    document.getElementById('result-title').innerText = `捜査結果: ${location}`;
    moreNote.classList.add('hidden');

    if (infoList.length > 0 && currentIndex < infoList.length) {
        const info = infoList[currentIndex];
        resultContent.innerText = info;
        if (!gameState.foundEvidences.includes(info)) gameState.foundEvidences.push(info);
        gameState.investigatedIndices[location] = currentIndex + 1;
        if (currentIndex + 1 < infoList.length) moreNote.classList.remove('hidden');
    } else {
        resultContent.innerText = "特に変わった様子はない。";
    }

    if (gameState.count >= MAX_SEARCH) {
        backBtn.innerText = "捜査を終了する";
        backBtn.style.background = "#c0392b";
        backBtn.onclick = () => showEnd("捜査可能回数の上限に達しました");
        showCustomModal("捜査回数が上限に達しました。");
    } else {
        backBtn.innerText = "戻る";
        backBtn.onclick = showList;
    }
    resultView.classList.remove('hidden');
    save();
}

function showEnd(reason) {
    hideAll();
    document.getElementById('end-reason').innerText = reason;
    document.getElementById('view-end').classList.remove('hidden');
    const copyArea = document.getElementById('copy-area');
    copyArea.value = "【入手した証拠一覧】\n" + (gameState.foundEvidences.length ? gameState.foundEvidences.map(e => "・" + e).join('\n') : "証拠は見つかりませんでした。");
}

init();
</script>
</body>
</html>
